name: Android Addon Build

on:
  workflow_dispatch:
    inputs:
      build_arch:
        description: "Android arch to build via ffmpeg-kit"
        required: false
        default: "arm64-v8a"

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Submodules
        run: git submodule update --init --recursive --force

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf automake libtool pkg-config curl git doxygen nasm cmake gcc g++ gperf texinfo yasm bison autogen wget autopoint \
            meson ninja-build ragel groff gtk-doc-tools libtasn1-6-dev unzip xz-utils python3-venv python3-pip findutils

      - name: Set up Android SDK/NDK
        env:
          ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
        run: |
          set -euo pipefail
          SDK_ROOT="$GITHUB_WORKSPACE/android-sdk"
          mkdir -p "$SDK_ROOT/cmdline-tools"
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d "$SDK_ROOT/cmdline-tools"
          mv "$SDK_ROOT/cmdline-tools/cmdline-tools" "$SDK_ROOT/cmdline-tools/latest"
          export ANDROID_SDK_ROOT="$SDK_ROOT"
          export ANDROID_HOME="$SDK_ROOT"
          export PATH="$SDK_ROOT/cmdline-tools/latest/bin:$SDK_ROOT/platform-tools:$SDK_ROOT/emulator:$PATH"
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platforms;android-33" "build-tools;33.0.2" "ndk;22.1.7171670"
          echo "ANDROID_SDK_ROOT=$SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$SDK_ROOT/ndk/22.1.7171670" >> $GITHUB_ENV

      - name: Build ffmpeg-kit for Android (${{ github.event.inputs.build_arch }})
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_ROOT: ${{ env.ANDROID_NDK_ROOT }}
        run: |
          set -euo pipefail
          cd ffmpeg-kit
          ARCH_INPUT="${{ github.event.inputs.build_arch }}"
          ARGS=""
          case "$ARCH_INPUT" in
            arm64-v8a)
              ARGS="--disable-arm-v7a --disable-arm-v7a-neon --disable-x86 --disable-x86-64"
              ;;
            *)
              echo "Unsupported build_arch '$ARCH_INPUT'" >&2
              exit 1
              ;;
          esac
          ./android.sh $ARGS

      - name: Locate ffmpeg-kit prebuilt root (arm64)
        id: locate
        run: |
          set -euo pipefail
          ROOT=$(dirname "$(find ffmpeg-kit/android/prebuilt -type f -name libavcodec.so -path '*arm64*' | head -n1)")/..
          if [ ! -d "$ROOT/include" ] || [ ! -d "$ROOT/lib" ]; then
            echo "Could not locate prebuilt include/lib under: $ROOT" >&2
            find ffmpeg-kit/android/prebuilt -maxdepth 4 -type d -printf '%p\n' | sed -n '1,200p'
            exit 1
          fi
          REALROOT=$(readlink -f "$ROOT")
          echo "ffroot=$REALROOT" >> $GITHUB_OUTPUT

      - name: Build Godot GDExtension (Android)
        run: |
          set -euo pipefail
          python3 -m venv venv
          . venv/bin/activate
          python -m pip install -U pip
          python -m pip install scons==4.4.0
          cd gdextension_build
          scons platform=android target=template_debug ffmpeg_path="${{ steps.locate.outputs.ffroot }}" debug_symbols=no
          scons platform=android target=template_release ffmpeg_path="${{ steps.locate.outputs.ffroot }}" debug_symbols=no

      - name: Upload addons artifact
        uses: actions/upload-artifact@v4
        with:
          name: addons-ffmpeg-android
          path: |
            gdextension_build/build/addons/ffmpeg
          if-no-files-found: error
